{% extends "base.html" %}

{% block title %}Utilidades{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h4 class="mb-1">Utilidades</h4>
      <div class="text-muted">Exportar segmentaciones e importar imágenes de referencias.</div>
    </div>
  </div>

  <div class="row g-3">
    <!-- IMPORTAR IMÁGENES -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">Importar imágenes</h5>
          <p class="text-muted mb-3">
            Sube imágenes (.png, .jpg, .jpeg, .webp). Se guardan en <code>static/assets/images/referencias/</code>.
            Si ya existe una imagen con la misma referencia, se <b>sobrescribe</b>.
          </p>

          <form id="formUploadImgs" class="d-flex flex-column gap-2">
            <input id="inputImgs" class="form-control" type="file" name="files" multiple accept=".png,.jpg,.jpeg,.webp">
            <button id="btnUpload" type="submit" class="btn btn-primary">
              Subir imágenes
            </button>
          </form>

          <div id="uploadStatus" class="mt-3" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- EXPORTAR SEGMENTACIONES -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">Exportar segmentaciones</h5>
          <p class="text-muted mb-3">
            Descarga el archivo CSV con todas las segmentaciones guardadas.
          </p>

          <a class="btn btn-outline-success" href="/segmentacion/api/export/csv">
            Descargar CSV
          </a>
        </div>
      </div>
    </div>
<!-- REINICIAR SEGMENTACIONES -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-danger">
        <div class="card-body">
          <h5 class="card-title mb-2 text-danger">Reiniciar segmentaciones</h5>
          <p class="text-muted mb-3">
            Esto eliminará todas las segmentaciones guardadas (cabecera y detalle). Esta acción no se puede deshacer.
          </p>

          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalResetSeg">
            Reiniciar
          </button>

          <div id="resetStatus" class="mt-3" style="display:none;"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal confirmación reset -->
<div class="modal fade" id="modalResetSeg" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title">¿Reiniciar segmentaciones?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        Vas a eliminar todas las segmentaciones guardadas. Esta acción no se puede deshacer.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">No</button>
        <button id="btnConfirmReset" type="button" class="btn btn-danger">Sí, reiniciar</button>
      </div>
    </div>
  </div>
</div>


<script>
(function () {
  const form = document.getElementById("formUploadImgs");
  const input = document.getElementById("inputImgs");
  const status = document.getElementById("uploadStatus");
  const btn = document.getElementById("btnUpload");

  function showAlert(html, type="info") {
    status.style.display = "block";
    status.className = "alert alert-" + type;
    status.innerHTML = html;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const files = input.files;
    if (!files || files.length === 0) {
      showAlert("Selecciona al menos un archivo.", "warning");
      return;
    }

    const fd = new FormData();
    for (const f of files) fd.append("files", f);

    btn.disabled = true;
    btn.textContent = "Subiendo...";

    try {
      const res = await fetch("/segmentacion/api/imagenes/upload", {
        method: "POST",
        body: fd
      });

      const json = await res.json().catch(() => null);
      if (!res.ok || !json || json.ok === false) {
        const msg = (json && (json.error || json.mensaje)) ? (json.error || json.mensaje) : ("HTTP " + res.status);
        showAlert("Error subiendo imágenes: " + msg, "danger");
        return;
      }

      const okCount = json?.resumen?.guardadas ?? 0;
      const badCount = json?.resumen?.rechazadas ?? 0;

      let html = `<b>Listo.</b> Guardadas: ${okCount} • Rechazadas: ${badCount}`;

      if (Array.isArray(json.rechazadas) && json.rechazadas.length > 0) {
        html += `<hr class="my-2"><div class="small"><b>Rechazadas</b></div><ul class="small mb-0">`;
        json.rechazadas.slice(0, 10).forEach(r => {
          html += `<li>${r.archivo}: ${r.motivo}</li>`;
        });
        if (json.rechazadas.length > 10) html += `<li>... (${json.rechazadas.length - 10} más)</li>`;
        html += `</ul>`;
      }

      showAlert(html, "success");
      input.value = ""; // limpia input

    } catch (err) {
      showAlert("Error inesperado: " + (err?.message || err), "danger");
    } finally {
      btn.disabled = false;
      btn.textContent = "Subir imágenes";
    }
  });

  // --- reset segmentaciones ---
  const resetStatus = document.getElementById("resetStatus");
  const btnConfirmReset = document.getElementById("btnConfirmReset");

  function showResetAlert(html, type="info") {
    resetStatus.style.display = "block";
    resetStatus.className = "alert alert-" + type;
    resetStatus.innerHTML = html;
  }

  if (btnConfirmReset) {
    btnConfirmReset.addEventListener("click", async () => {
      btnConfirmReset.disabled = true;
      btnConfirmReset.textContent = "Reiniciando...";

      try {
        const res = await fetch("/segmentacion/api/segmentaciones/reset", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({})
        });

        const json = await res.json().catch(() => null);

        if (!res.ok || !json || json.ok === false) {
          const msg = (json && (json.error || json.mensaje)) ? (json.error || json.mensaje) : ("HTTP " + res.status);
          showResetAlert("No se pudo reiniciar: " + msg, "danger");
          return;
        }

        showResetAlert("<b>Listo.</b> Segmentaciones reiniciadas.", "success");

        // cerrar modal
        const modalEl = document.getElementById("modalResetSeg");
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();

      } catch (err) {
        showResetAlert("Error inesperado: " + (err?.message || err), "danger");
      } finally {
        btnConfirmReset.disabled = false;
        btnConfirmReset.textContent = "Sí, reiniciar";
      }
    });
  }
})();
</script>
{% endblock %}
